var $colorsOptions,$densityPrice,$existenceOptions,$expectedOptions,docWidth,renderColorOptions,renderCount,renderDensityOptions,indexOf=[].indexOf;import{log,el,ev,makeObserveble,nodeObserver,els}from"/js/ksk-lib.js";import{store}from"/js/store.js";import{ws_handlers}from"/js/ws.js";export var current=makeObserveble({density:null,color:null});store.addObserver(function(e,t,r){"dataFromServer"===t&&(r.addObserver(function(e,t,r){"density"===t&&renderDensityOptions()}),renderDensityOptions())});export var $options=el("#shirts .options");$densityPrice=el(".density-price",$options),(docWidth=document.documentElement.clientWidth)<=1200&&el("#shirts>div:last-child").prepend($options),renderDensityOptions=function(){var e,t,r,n,i,s,o,c,d,a,l;for(({density:i}=store.dataFromServer),t=document.createElement("ul"),o=0,d=i.length;o<d;o++)n=i[o],(e=document.createElement("li")).densityId=n.id,e.innerText=n.code+" г/м²",t.append(e);for($densityPrice.before(t),nodeObserver(t,{subtree:!0,attributes:!0,attributeFilter:["class"]},function(e){var t,r,s,o,c,d;if("attributes"===e.type&&"LI"===e.target.tagName&&e.target.classList.contains("active")){for(current.density=e.target.densityId,c=[(n=i.find(function(t){return t.id===e.target.densityId})).price,n.price_100,n.price_1000,n.price_1000-5],r=s=0,o=(d=els("li",$densityPrice)).length;s<o;r=++s)t=d[r],el("span:last-child",t).innerText=3===r?`${c[r]}₽ и ниже`:`${c[r]}₽`;renderColorOptions()}}),s=c=0,a=(l=els("li",t)).length;c<a;s=++c)r=l[s],0===s&&r.classList.add("active"),ev(r,"click",function(e){this.classList.contains("active")||(el(".active",t).classList.remove("active"),this.classList.add("active"))})},$colorsOptions=el(".color",$options),renderColorOptions=function(){var e,t,r,n,i,s,o,c,d,a,l,u,p,f;for((f=el("ul",$colorsOptions))&&f.remove(),(p=store.dataFromServer.shirts.filter(function(e){return e.density_id===current.density})).sort(function(e,t){return e.id-t.id}),i=new Set(function(){var e,t,r;for(r=[],e=0,t=p.length;e<t;e++)s=p[e],r.push(s.color_id);return r}()),n=function(){var e,t,r,n;for(n=[],e=0,t=(r=Array.from(i)).length;e<t;e++)s=r[e],n.push(store.dataFromServer.colors.find(function(e){return e.id===s}));return n}(),e=document.createElement("ul"),o=0,d=n.length;o<d;o++)r=n[o],(t=document.createElement("li")).colorId=r.id,t.style.backgroundColor="#"+r.hex,e.append(t);for($colorsOptions.append(e),nodeObserver(e,{subtree:!0,attributes:!0,attributeOldValue:!0},function(e){"attributes"===e.type&&"LI"===e.target.tagName&&e.target.classList.contains("active")&&(current.color=e.target.colorId,renderCount())}),l=els("li",e),u=[],s=c=0,a=l.length;c<a;s=++c)t=l[s],0===s&&t.classList.add("active"),u.push(ev(t,"click",function(t){this.classList.contains("active")||(el(".active",e).classList.remove("active"),this.classList.add("active"))}));return u},$existenceOptions=el(".existence",$options),$expectedOptions=el(".expected",$options),renderCount=function(){var e,t,r,n,i,s,o,c,d,a,l,u,p,f,m,v,h;for(p=store.dataFromServer.shirts.filter(function(e){return e.density_id===current.density&&e.color_id===current.color}),f=function(){var e,t,r;for(r=[],e=0,t=p.length;e<t;e++)o=p[e],r.push(o.id);return r}(),s=store.dataFromServer.expected.filter(function(e){var t;return t=e.shirt_id,indexOf.call(f,t)>=0}),v=store.dataFromServer.sizes,0===s.length?$expectedOptions.classList.add("empty"):$expectedOptions.classList.remove("empty"),(h=el("ul",$existenceOptions))&&h.remove(),p.sort(function(e,t){return e.id-t.id}),e=document.createElement("ul"),c=0,a=p.length;c<a;c++)u=p[c],m=v.find(function(e){return e.id===u.size_id}).euro,(r=document.createElement("li")).innerHTML=`${m}: <span>${u.count} шт.</span>`,e.append(r);if($existenceOptions.append(e),(h=el("ul",$expectedOptions))&&h.remove(),s.length>0){for(t=document.createElement("ul"),d=0,l=s.length;d<l;d++)i=s[d],m=v.find(function(e){return e.id===p.find(function(e){return e.id===i.shirt_id}).size_id}).euro,n=new Date(i.date).toLocaleDateString("ru",{day:"numeric",month:"long",year:"numeric"}),(r=document.createElement("li")).innerHTML=`${m}: <span>${i.count} шт.</span> ${n}`,t.append(r);$expectedOptions.append(t)}},ws_handlers.set("shirts-count-subtract",function(e){var t,r,n,i;for(r=0,n=e.length;r<n;r++)i=e[r],t=store.dataFromServer.shirts.findIndex(function(e){return e.id===i.id}),store.dataFromServer.shirts[t].count=i.count,renderCount()});